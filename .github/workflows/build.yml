name: Build CI

on: 
  pull_request_target: 
    branches: [ main ]

  workflow_dispatch:

env:
  MY_SECRET: ${{ secrets.MY_SECRET }}
  GITHUB_PAT: ${{ secrets.GH_PAT }}
  PR_ID: ${{github.event.number}}

  XY_PRJ_NAME: LGV-GH-${{ github.event.repository.name }}
  PIPELINE: ${{ github.event.repository.name }}
  PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
  KEY_PASSWD: ${{ secrets.KEY_PASSWD }}
  API_KEY: ${{ secrets.XYGENI_TOKEN }}
  OTRA_VAR: "hola"
  
jobs:
                
  prt_build_and_upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checking out PR code
        uses: actions/checkout@v4
        if: ${{ github.event_name == 'pull_request_target' }}
        with:
          # Number of commits to fetch. 0 indicates all history for all branches and tags.
          # Default: 1
          fetch-depth: '0'
          # This is to get the PR code instead of the repo code
          ref: ${{ github.event.pull_request.head.sha }}

      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4
        name: Checking out main code
        if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch' }}
        with:
          # Number of commits to fetch. 0 indicates all history for all branches and tags.
          # Default: 1
          fetch-depth: '0'

      - name: Building ... 
        run: |
          mkdir ./bin
          touch ./bin/mybin.exe
          echo "${{github.event.pull_request.title}}" > ./bin/PR_TITLE.txt
          echo "$PR_ID" > ./bin/PR_ID.txt
          ls -lR 
        #env:
        #  PR_TITLE: ${{github.event.pull_request.title}}
 
      
      - name: Download SALT
        run: |
              #!/usr/bin/env bash
              echo Downloading SALT ....
              curl -sLO https://get.xygeni.io/latest/salt/salt.zip
              #export SALT_DIR=$PWD/salt_pro
              unzip salt.zip -d ./salt_pro
              shopt -s expand_aliases
              alias salt=$PWD/salt_pro/xygeni_salt/salt
              #salt --help 
      
              #chmod +x $SALT_DIR/xygeni_salt/salt
              #ls -l $SALT_DIR/xygeni_salt/salt
              #$SALT_DIR/xygeni_salt/salt
              #cd $SALT_DIR/xygeni_salt
        env:
          GITHUB_PAT: ${{ secrets.GH_PAT }}

      
      - name: Calc SHA for bin and addes as zip to the artifact
        run: |
                #!/usr/bin/env bash
                #pwd
                #ls -l
                #cd bin
                #ls -l
                #sha256sum <(find . -type f -exec sha256sum {} \; | sort)
  
                zip -r ./bin.zip ./bin
                cp ./bin.zip ./bin
                SHA_SUM=$(sha256sum ./bin.zip | cut -f1 -d ' ')
                echo $SHA_SUM

              
      - name: Generating provenance
        env:
          GITHUB_PAT: ${{ secrets.GH_PAT }}
        run: |
              #!/usr/bin/env bash    
              
              shopt -s expand_aliases
              alias salt=$PWD/salt_pro/xygeni_salt/salt
              
      
              echo " "
              echo "-----------"
              echo "Generating Provenance with CLI ..."
              #$SALT_PATH/salt at provenance 
              salt at slsa \
                  --basedir ${GITHUB_WORKSPACE} \
                  --key="${PRIVATE_KEY}" --public-key=${GITHUB_WORKSPACE}/Test1_public.pem --key-password=${KEY_PASSWD} \
                  --output-unsigned=${GITHUB_WORKSPACE}/cli_provenance_${PIPELINE}_unsigned.json \
                  --pipeline ${PIPELINE} --pretty-print \
                  --file ./bin/bin.zip \
                  > ${GITHUB_WORKSPACE}/lgv.txt
      
              cat ${GITHUB_WORKSPACE}/cli_provenance_${PIPELINE}_unsigned.json
              cat ${GITHUB_WORKSPACE}/lgv.txt
              echo "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
              
              grep "registry with id" lgv.txt | awk '{print $14}' > ./bin/att.id

              
      


      - name: Archive building artifacts
        uses: actions/upload-artifact@v3
        with:
          name: archive-bin
          path: |
            bin


